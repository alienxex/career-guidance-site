<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Career Guidance | Gemini Powered</title>
    <meta name="description" content="AI-driven career pathfinder powered by Google Gemini.">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap');
        
        :root {
            --glass-bg: rgba(0, 0, 0, 0.85);
            --glass-border: rgba(255, 255, 255, 0.15);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #000000; 
            color: #e4e4e7; /* Zinc-200 */
            overflow-x: hidden;
            margin: 0;
        }

        h1, h2, h3, .brand-font {
            font-family: 'Space Grotesk', sans-serif;
        }

        /* --- 3D Background Canvas --- */
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            background: radial-gradient(circle at center, #18181b 0%, #000000 100%);
            pointer-events: none;
        }

        /* --- Glassmorphism Card --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 0 40px rgba(255, 255, 255, 0.05);
        }

        /* --- Custom Inputs --- */
        .input-mono {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            transition: all 0.3s ease;
        }
        .input-mono:focus {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: #ffffff;
            outline: none;
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.5);
        }
        .input-mono.error {
            border-color: #ef4444; /* Red-500 */
        }

        /* --- Monochrome Buttons --- */
        .btn-mono {
            transition: all 0.2s ease;
            transform: translateY(0);
        }
        .btn-mono-primary {
            background-color: #ffffff;
            color: #000000;
            border: 1px solid #ffffff;
        }
        .btn-mono-primary:hover:not(:disabled) {
            background-color: #d4d4d8;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }
        .btn-mono-secondary {
            background-color: transparent;
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .btn-mono-secondary:hover:not(:disabled) {
            border-color: #ffffff;
            background-color: rgba(255, 255, 255, 0.05);
        }
        .btn-mono:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        /* --- Selection Styles --- */
        .selection-card {
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0,0,0,0.4);
        }
        .selection-card.active {
            background: #ffffff;
            color: #000000;
            border-color: #ffffff;
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.15);
        }
        .selection-card.active span {
            font-weight: 700;
        }
        .selection-card:hover:not(.active) {
            border-color: rgba(255, 255, 255, 0.6);
        }

        /* --- Quiz Animations --- */
        .slide-in-right { animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .slide-out-left { animation: slideOutLeft 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes slideOutLeft {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(-50px); }
        }

        /* --- Utilities --- */
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #52525b; border-radius: 2px; }
        
        /* Markdown Styles for AI Response */
        .ai-response strong { color: white; font-weight: 700; }
        .ai-response ul { list-style-type: disc; padding-left: 1.2em; margin-top: 0.5em; margin-bottom: 0.5em; }
        .ai-response li { margin-bottom: 0.3em; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Background -->
    <div id="canvas-container"></div>

    <!-- Main Application Card -->
    <div id="app" class="glass-panel rounded-none w-full max-w-2xl p-8 md:p-12 relative z-10 hidden opacity-0 transition-opacity duration-700 flex flex-col min-h-[600px] border-l border-r border-zinc-800">
        
        <!-- Header -->
        <header class="mb-8 flex justify-between items-start border-b border-zinc-800 pb-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-white tracking-tight uppercase cursor-pointer" onclick="location.reload()">
                    CAREER<span class="font-light text-zinc-500">GUIDANCE</span>
                </h1>
                <p class="text-zinc-500 text-xs mt-1 font-mono tracking-widest uppercase">Powered by Google Gemini</p>
            </div>
            <div class="flex flex-col items-end gap-2">
                <div id="progress-text" class="text-xs font-mono text-white hidden md:block">00%</div>
                <button id="settings-btn" class="text-zinc-500 hover:text-white transition-colors" title="Configure AI Model">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- Progress Bar -->
        <div id="progress-container" class="absolute top-0 left-0 w-full h-1 bg-zinc-900 hidden overflow-hidden">
            <div id="progress-bar" class="bg-white h-full transition-all duration-500 ease-out" style="width: 0%"></div>
        </div>

        <!-- Initial Loader -->
        <div id="initial-loading" class="flex flex-col items-center justify-center flex-grow">
            <div class="spinner w-8 h-8 mb-4"></div>
            <p class="text-zinc-400 text-xs font-mono animate-pulse uppercase">Initializing Gemini Core...</p>
        </div>

        <!-- Dynamic Content Area -->
        <main id="content-area" class="flex-grow hidden relative min-h-[350px] flex flex-col">
            <!-- Content injected via JS -->
        </main>

        <!-- Navigation Footer -->
        <footer id="nav-footer" class="mt-auto pt-6 border-t border-zinc-800 flex justify-between items-center hidden">
            <button id="back-btn" type="button" class="btn-mono btn-mono-secondary px-6 py-3 rounded-none text-xs font-bold uppercase tracking-widest">
                Back
            </button>
            
            <div class="flex items-center gap-4">
                <button id="next-btn" type="button" class="btn-mono btn-mono-primary px-8 py-3 rounded-none text-xs font-bold uppercase tracking-widest disabled:opacity-50">
                    Next Step
                </button>
                <button id="calculate-btn" type="button" class="hidden btn-mono btn-mono-primary px-8 py-3 rounded-none text-xs font-bold uppercase tracking-widest">
                    Analyze Profile
                </button>
            </div>
        </footer>

        <!-- System Message -->
        <div id="message-box" role="alert" aria-live="polite" class="mt-4 p-3 text-xs font-mono text-center hidden transition-all border border-zinc-800 bg-black"></div>
    </div>

    <!-- Welcome / Hero Overlay -->
    <div id="welcome-screen" class="fixed inset-0 z-40 flex flex-col items-center justify-center pointer-events-none hidden bg-black">
        <div class="text-center pointer-events-auto transform transition-transform duration-700 p-6 border border-zinc-800 bg-black/50 backdrop-blur-md p-10 max-w-lg w-full">
            <div class="mb-8">
                <h1 class="text-5xl md:text-6xl font-bold text-white tracking-tighter mb-2">
                    CAREER<br/><span class="font-thin text-zinc-500">MATRIX</span>
                </h1>
                <div class="h-1 w-20 bg-white mx-auto mt-4"></div>
            </div>
            <p class="text-zinc-400 text-sm mb-10 font-light leading-relaxed max-w-xs mx-auto">
                Advanced career pathfinding using <strong>Google Gemini</strong> AI. Identify your ideal trajectory based on Aptitude, Marks, and Personality.
            </p>
            
            <button id="start-btn" type="button"
                    class="btn-mono btn-mono-primary w-full py-4 text-sm font-bold uppercase tracking-[0.2em] hover:bg-zinc-200 transition-colors">
                Initialize System
            </button>
        </div>
    </div>

    <!-- AI Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 hidden backdrop-blur-sm fade-in">
        <div class="bg-zinc-900 border border-zinc-700 p-8 max-w-md w-full relative shadow-2xl">
            <button id="close-settings" class="absolute top-4 right-4 text-zinc-500 hover:text-white">&times;</button>
            <h3 class="text-lg font-bold text-white mb-4 font-mono uppercase">Gemini Configuration</h3>
            <p class="text-zinc-400 text-xs mb-6 leading-relaxed">
                Enable smart insights using the Google Gemini API.
                <br/><br/>
                1. Get a FREE API key from <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-white underline">Google AI Studio</a>
                <br/>
                2. Paste it below.
            </p>
            <label class="block text-[10px] font-bold text-zinc-500 uppercase mb-2">Gemini API Key</label>
            <input id="hf-token-input" type="password" class="w-full p-3 input-mono text-sm mb-6" placeholder="AIza...">
            
            <div class="flex justify-end gap-4">
                <button id="save-settings" class="btn-mono btn-mono-primary px-6 py-2 text-xs font-bold uppercase">Save Key</button>
            </div>
        </div>
    </div>

<!-- Module Logic -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    /* =========================================
       MODULE: GEMINI AI INTEGRATION
    ========================================= */
    const AIModule = {
        token: localStorage.getItem('gemini_token') || "",

        saveToken(token) {
            this.token = token;
            localStorage.setItem('gemini_token', token);
        },

        async generateInsight(profile) {
            if (!this.token) return null;

            const is10th = profile.user.grade === '10';
            const lowMarks = parseInt(profile.user.marks) < 60;
            
            const prompt = `
            You are a senior career counselor. Analyze this student:
            - Name: ${profile.user.name}
            - Grade: ${profile.user.grade}
            - Marks: ${profile.user.marks}%
            - ${is10th ? 'Strongest Subject: '+profile.user.subject : 'Stream: '+profile.user.stream}
            - Interests: ${profile.interests.join(', ')}
            - Top Traits: ${Object.entries(profile.scores).sort((a,b)=>b[1]-a[1]).slice(0,3).map(x=>x[0]).join(', ')}

            ${lowMarks ? "IMPORTANT: This student has lower academic marks. Focus on SKILLS, VOCATIONAL PATHS, and PRACTICAL STRENGTHS." : ""}

            Provide a 3-point analysis using bolding for key terms:
            1. Recommended Path (${is10th ? 'Stream' : 'Career Role'}).
            2. Why it fits their personality/interests.
            3. A practical first step (Course, Project, or Skill).
            
            Keep it concise and professional.
            `;

            try {
                const url = https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${this.token};
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) throw new Error("Gemini API Error");
                const result = await response.json();
                return result.candidates[0].content.parts[0].text;
            } catch (e) { 
                console.error(e); 
                return null; 
            }
        },

        async generateRoadmap(profile) {
            if (!this.token) return null;
            
            const prompt = `
            Create a 4-week crash course roadmap for a student interested in ${profile.recommendations[0]?.name || 'their field'} with traits ${Object.entries(profile.scores).sort((a,b)=>b[1]-a[1]).slice(0,2).map(x=>x[0]).join(', ')}.
            Format as simple Markdown with Week 1, Week 2, etc. Focus on practical steps.
            `;

            try {
                const url = https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${this.token};
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) throw new Error("Gemini API Error");
                const result = await response.json();
                return result.candidates[0].content.parts[0].text;
            } catch (e) { console.error(e); return "Error generating roadmap."; }
        }
    };

    /* =========================================
       MODULE: 3D BACKGROUND
    ========================================= */
    const ThreeBG = {
        init() {
            const container = document.getElementById('canvas-container');
            if (!container || !window.THREE) return;
            const scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.002);
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            container.appendChild(renderer.domElement);
            scene.add(new THREE.AmbientLight(0x404040, 2));
            const dirLight = new THREE.DirectionalLight(0xffffff, 1);
            dirLight.position.set(10, 10, 5);
            scene.add(dirLight);
            const gridHelper = new THREE.GridHelper(100, 50, 0x333333, 0x111111);
            gridHelper.position.y = -10;
            scene.add(gridHelper);
            const particleCount = 30;
            const geometry = new THREE.TetrahedronGeometry(1, 0);
            const material = new THREE.MeshBasicMaterial({ color: 0x52525b, wireframe: true, transparent: true, opacity: 0.3 });
            const group = new THREE.Group();
            scene.add(group);
            for (let i = 0; i < particleCount; i++) {
                const mesh = new THREE.Mesh(geometry, material);
                mesh.position.set((Math.random()-0.5)*50, (Math.random()-0.5)*50, (Math.random()-0.5)*30);
                mesh.rotation.set(Math.random()*Math.PI, Math.random()*Math.PI, 0);
                mesh.userData = { speed: Math.random()*0.01 + 0.005 };
                group.add(mesh);
            }
            camera.position.z = 20;
            const animate = () => {
                requestAnimationFrame(animate);
                group.rotation.y += 0.002;
                group.children.forEach(m => { m.rotation.x += m.userData.speed; m.rotation.y += m.userData.speed; });
                renderer.render(scene, camera);
            };
            animate();
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }
    };

    /* =========================================
       MODULE: UTILITIES
    ========================================= */
    const Utils = {
        sanitize: (str) => {
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        },
        showError: (inputId, msg, show) => {
            const input = document.getElementById(inputId);
            if(!input) return;
            let errEl = document.getElementById(inputId + "-error");
            if (!errEl) {
                errEl = document.createElement('p');
                errEl.id = inputId + "-error";
                errEl.className = "text-red-500 text-[10px] mt-1 font-mono hidden";
                input.parentNode.insertBefore(errEl, input.nextSibling);
            }
            if (show) { input.classList.add('error'); errEl.textContent = > ${msg}; errEl.classList.remove('hidden'); }
            else { input.classList.remove('error'); errEl.classList.add('hidden'); }
        }
    };

    /* =========================================
       MODULE: APP DATA & LOGIC
    ========================================= */
    const AppData = {
        traits: ['Logic', 'Creativity', 'Communication', 'DetailOrientation', 'Empathy', 'Physical', 'Resilience'],
        
        streams: [
            { id: 'SciencePCM', label: 'Science (PCM)' },
            { id: 'SciencePCB', label: 'Science (PCB)' },
            { id: 'Commerce', label: 'Commerce' },
            { id: 'Arts', label: 'Arts & Humanities' }
        ],

        subjects: [
            { id: 'Math', label: 'Mathematics' },
            { id: 'Science', label: 'Science' },
            { id: 'Social', label: 'Social Studies' },
            { id: 'English', label: 'English/Literature' },
            { id: 'Arts', label: 'Arts/Craft' },
            { id: 'CompApp', label: 'Computer Applications' }
        ],

        interestsList: [
            { id: 'Sports', label: 'Sports & Fitness', streams: ['All'], tags: ['Sports', 'Physical'] },
            { id: 'Gaming', label: 'Gaming & Esports', streams: ['All'], tags: ['Tech', 'Creativity'] },
            { id: 'Music', label: 'Music & Audio', streams: ['All'], tags: ['Creativity', 'Communication'] },
            { id: 'SocialService', label: 'Social Service', streams: ['All'], tags: ['Empathy', 'Social'] },
            { id: 'Management', label: 'Leadership', streams: ['All'], tags: ['Communication', 'Logic'] },
            { id: 'Coding', label: 'Coding/Software', streams: ['SciencePCM'], tags: ['Tech', 'Logic'] },
            { id: 'Robotics', label: 'Robotics', streams: ['SciencePCM'], tags: ['Mech', 'Tech'] },
            { id: 'Space', label: 'Astronomy', streams: ['SciencePCM'], tags: ['Research', 'Logic'] },
            { id: 'Architecture', label: 'Design & Build', streams: ['SciencePCM'], tags: ['Design', 'Logic'] },
            { id: 'Medicine', label: 'Medicine', streams: ['SciencePCB'], tags: ['Bio', 'Empathy'] },
            { id: 'Psychology', label: 'Psychology', streams: ['SciencePCB', 'Arts'], tags: ['Bio', 'Social'] },
            { id: 'Stocks', label: 'Stocks/Trading', streams: ['Commerce'], tags: ['Finance', 'Logic'] },
            { id: 'Economics', label: 'Economics', streams: ['Commerce', 'Arts'], tags: ['Finance', 'Research'] },
            { id: 'Writing', label: 'Journalism', streams: ['Arts'], tags: ['Media', 'Creativity'] },
            { id: 'Law', label: 'Law & Debate', streams: ['Arts', 'Commerce'], tags: ['Law', 'Logic'] },
            { id: 'History', label: 'History', streams: ['Arts'], tags: ['Research', 'Communication'] },
            { id: 'Photography', label: 'Photography', streams: ['All'], tags: ['Design', 'Creativity'] }
        ],

        // EXTENDED QUESTION BANK
        questionBank: [
            { tags: ['Logic'], text: "I enjoy solving complex puzzles or math problems.", weights: { Logic: 5, Creativity: -1 } },
            { tags: ['Logic'], text: "I like analyzing data to find trends or patterns.", weights: { Logic: 5, DetailOrientation: 3 } },
            { tags: ['Creativity'], text: "I often have ideas for new inventions or stories.", weights: { Creativity: 5, Logic: 1 } },
            { tags: ['Design'], text: "I notice when a website or poster has bad colors or fonts.", weights: { Creativity: 5, DetailOrientation: 3 } },
            { tags: ['Communication'], text: "I feel confident speaking in front of a group.", weights: { Communication: 5, Empathy: 1 } },
            { tags: ['Social'], text: "I want a career where I directly help people improve their lives.", weights: { Empathy: 5, Communication: 3 } },
            { tags: ['Tech'], text: "I wonder how the apps on my phone actually work behind the scenes.", weights: { Logic: 4, Creativity: 2 } },
            { tags: ['Bio'], text: "I am not grossed out by blood or biology experiments.", weights: { DetailOrientation: 4, Empathy: 3 } },
            { tags: ['Finance'], text: "I like the idea of managing money or starting a business.", weights: { Logic: 3, Communication: 4 } },
            { tags: ['Law'], text: "I enjoy debating and proving my point with logic.", weights: { Logic: 4, Communication: 4 } },
            { tags: ['Personality'], text: "I usually take charge in group projects.", weights: { Communication: 5, Logic: 2 } },
            { tags: ['Personality'], text: "I prefer planning everything in detail before starting.", weights: { DetailOrientation: 5, Creativity: -1 } },
            { tags: ['Grit'], text: "I keep trying even when a problem seems impossible.", weights: { Resilience: 5, Logic: 2 } },
            { tags: ['Practical'], text: "I prefer learning by doing with my hands rather than reading.", weights: { Physical: 5, Logic: 2 } },
            { tags: ['Practical'], text: "I enjoy fixing things that are broken around the house.", weights: { Physical: 4, Logic: 4 } },
            { tags: ['Physical'], text: "I would hate a job where I have to sit at a desk all day.", weights: { Physical: 5, DetailOrientation: -2 } }
        ],

        streamDatabase: [
            { name: "Science (PCM)", subject: ["Math", "Science", "CompApp"], tags: ["Tech", "Logic", "Mech", "Research"], desc: "Engineering, Architecture, Aviation.", path: "Select PCM in Class 11" },
            { name: "Science (PCB)", subject: ["Science", "English"], tags: ["Bio", "Nature", "Medicine", "Research"], desc: "Medicine, Psychology, Biotech.", path: "Select PCB in Class 11" },
            { name: "Commerce", subject: ["Math", "Social"], tags: ["Finance", "Business", "Stocks", "Management"], desc: "CA, MBA, Economics, Business.", path: "Select Commerce in Class 11" },
            { name: "Arts & Humanities", subject: ["Social", "English", "Arts"], tags: ["Media", "Law", "Writing", "Fashion", "Social"], desc: "Law, Design, Journalism, Civil Services.", path: "Select Arts in Class 11" }
        ],

        careerDatabase: [
            { name: "Software Engineer", stream: ["SciencePCM"], tags: ["Tech", "Logic"], desc: "Building digital systems.", path: "B.Tech CSE" },
            { name: "Doctor (MBBS)", stream: ["SciencePCB"], tags: ["Medicine", "Bio"], desc: "Treating patients.", path: "NEET -> MBBS" },
            { name: "Chartered Accountant", stream: ["Commerce"], tags: ["Accounting", "Finance"], desc: "Financial auditing.", path: "CA Course" },
            { name: "Lawyer", stream: ["Arts", "Commerce"], tags: ["Law", "Debate"], desc: "Legal advocacy.", path: "BA LLB" },
            { name: "Graphic Designer", stream: ["Arts", "SciencePCM"], tags: ["Design", "Tech"], desc: "Visual communication.", path: "B.Des" },
            { name: "Data Scientist", stream: ["SciencePCM", "Commerce"], tags: ["Math", "Tech"], desc: "Analyzing data.", path: "B.Sc Data Science" },
            { name: "Psychologist", stream: ["SciencePCB", "Arts"], tags: ["Bio", "Social"], desc: "Mental health therapy.", path: "BA/B.Sc Psychology" },
            { name: "Entrepreneur", stream: ["Commerce", "Arts", "SciencePCM"], tags: ["Business", "Management"], desc: "Starting ventures.", path: "BBA / MBA" },
            { name: "Professional Athlete", stream: ["Arts", "SciencePCM", "Commerce"], tags: ["Sports", "Physical"], desc: "Competitive sports.", path: "Sports Academy" },
            { name: "Electrician/Technician", stream: ["SciencePCM", "Arts"], tags: ["Practical", "Tech"], desc: "Skilled trade work.", path: "ITI / Diploma" },
            { name: "Event Manager", stream: ["Commerce", "Arts"], tags: ["Management", "Social"], desc: "Organizing large events.", path: "BBA Event Mgmt" }
        ],

        state: {
            step: 0,
            user: { name: '', grade: '10', stream: '', subject: '', marks: '', interests: [] },
            answers: {},
            activeQuestions: [],
            recommendations: [],
            scores: {},
            aiResponse: null,
            isRefining: false,
            refinedInterests: [],
            quizIndex: 0
        },

        checkAmbiguity() {
            const rawScores = {};
            this.traits.forEach(t => rawScores[t] = 0);
            this.state.activeQuestions.forEach(q => {
                const val = this.state.answers[q.id] || 3;
                for (const t in q.weights) rawScores[t] += (val - 3) * q.weights[t];
            });
            const scores = {};
            this.traits.forEach(t => scores[t] = Math.max(0, Math.min(100, 50 + (rawScores[t] * 5))));
            const topTraitScore = Math.max(...Object.values(scores));
            const minTraitScore = Math.min(...Object.values(scores));
            return (topTraitScore - minTraitScore) < 15 || this.state.user.interests.length > 5;
        },

        generateQuiz() {
            const marks = parseInt(this.state.user.marks) || 0;
            const targetLength = marks < 60 ? 15 : 10;

            const userInterests = this.state.user.interests; 
            const relevantTags = new Set();
            userInterests.forEach(intId => {
                const interestObj = this.interestsList.find(i => i.id === intId);
                if(interestObj) interestObj.tags.forEach(t => relevantTags.add(t));
            });

            let matchedQuestions = this.questionBank.filter(q => 
                q.tags.some(t => relevantTags.has(t))
            ).map(q => ({...q, id: dyn_${Math.random().toString(36).substr(2,9)}}));
            matchedQuestions.sort(() => 0.5 - Math.random());

            const baseQuestions = this.questionBank.filter(q => 
                ['Personality', 'Grit', 'Logic', 'Creativity'].includes(q.tags[0])
            ).map((q,i) => ({...q, id: base_${i}}));
            
            const practicalQuestions = this.questionBank.filter(q => 
                ['Practical', 'Physical'].includes(q.tags[0])
            ).map((q,i) => ({...q, id: prac_${i}}));

            let quizSet = [...matchedQuestions];
            quizSet = [...quizSet, ...baseQuestions];
            if (marks < 60) {
                quizSet = [...quizSet, ...practicalQuestions];
            }
            quizSet = quizSet.filter((v,i,a)=>a.findIndex(t=>(t.text===v.text))===i);
            
            if (quizSet.length > targetLength) {
                quizSet = quizSet.slice(0, targetLength); 
            }

            this.state.activeQuestions = quizSet;
            this.state.quizIndex = 0;
        },

        calculateResults() {
            const { answers, activeQuestions } = this.state;
            const raw = {}; 
            this.traits.forEach(t => raw[t] = 0);
            activeQuestions.forEach(q => {
                const val = answers[q.id] || 3;
                for (const t in q.weights) raw[t] += (val - 3) * q.weights[t];
            });
            this.traits.forEach(t => {
                this.state.scores[t] = Math.max(0, Math.min(100, 50 + (raw[t] * 5)));
            });

            let userInterests = this.state.user.interests;
            if (this.state.isRefining && this.state.refinedInterests.length > 0) {
                userInterests = this.state.refinedInterests;
            }

            if (this.state.user.grade === '10') {
                const userSubject = this.state.user.subject;
                const rankedStreams = this.streamDatabase.map(stream => {
                    let score = 0;
                    if(stream.subject.includes(userSubject)) score += 40;
                    const userTags = new Set();
                    userInterests.forEach(intId => {
                        const obj = this.interestsList.find(i => i.id === intId);
                        if(obj) obj.tags.forEach(t => userTags.add(t));
                    });
                    const tagMatch = stream.tags.filter(t => userTags.has(t)).length;
                    score += tagMatch * 15;
                    return { ...stream, finalScore: Math.min(99, 40 + score + Math.floor(Math.random()*10)) };
                });
                this.state.recommendations = rankedStreams.sort((a,b) => b.finalScore - a.finalScore).slice(0, 2);
            } else {
                const userStream = this.state.user.stream;
                let candidates = this.careerDatabase.filter(job => job.stream.includes(userStream));
                
                if (candidates.length < 3 || parseInt(this.state.user.marks) < 60) {
                    candidates = [...candidates, ...this.careerDatabase.filter(job => 
                        job.stream.includes("Arts") || job.tags.includes("Practical") || job.tags.includes("Sports")
                    )];
                }

                const ranked = candidates.map(job => {
                    let score = 0;
                    const userTags = new Set();
                    userInterests.forEach(intId => {
                        const obj = this.interestsList.find(i => i.id === intId);
                        if(obj) obj.tags.forEach(t => userTags.add(t));
                    });
                    const tagMatchCount = job.tags.filter(t => userTags.has(t)).length;
                    const multiplier = this.state.isRefining ? 40 : 25;
                    score += tagMatchCount * multiplier; 
                    
                    if (job.tags.includes("Practical") && this.state.scores['Physical'] > 60) score += 30;

                    return { ...job, finalScore: Math.min(99, Math.round(score + 50)) };
                });
                const uniqueRanked = ranked.filter((v,i,a)=>a.findIndex(t=>(t.name===v.name))===i);
                this.state.recommendations = uniqueRanked.sort((a,b) => b.finalScore - a.finalScore).slice(0, 3);
            }
        }
    };

    /* =========================================
       MODULE: FIREBASE
    ========================================= */
    const FirebaseModule = {
        db: null, userId: null,
        async init() {
            const configRaw = (typeof _firebase_config !== 'undefined') ? JSON.parse(_firebase_config) : null;
            if (!configRaw) return;
            try {
                const app = initializeApp(configRaw);
                this.db = getFirestore(app);
                const auth = getAuth(app);
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => { 
                    if(user) { this.userId = user.uid; } 
                });
            } catch (e) { 
                console.error("Firebase Init Error:", e); 
                if (typeof UI !== 'undefined') UI.toast("Cloud sync unavailable", true); 
            }
        },
        async save() {
            if (!this.db || !this.userId) return;
            const appId = (typeof __app_id !== 'undefined') ? __app_id : 'default';
            try {
                await setDoc(doc(this.db, artifacts/${appId}/users/${this.userId}/results, result_${Date.now()}), AppData.state);
                if (typeof UI !== 'undefined') UI.toast("DATA SYNCED TO CLOUD");
            } catch (e) { 
                console.error("Save Failed:", e);
                if (typeof UI !== 'undefined') UI.toast("SYNC FAILED", true); 
            }
        }
    };

    /* =========================================
       MODULE: UI CONTROLLER
    ========================================= */
    const UI = {
        els: {},
        steps: [
            { id: 0, render: 'renderIdentity', validate: 'validateIdentity' },
            { id: 1, render: 'renderBackground', validate: 'validateBackground' },
            { id: 2, render: 'renderInterests', validate: 'validateInterests' },
            { id: 3, render: 'renderQuiz', validate: () => true },
            { id: 4, render: 'renderResults', validate: () => true }
        ],

        init() {
            this.els = {
                app: document.getElementById('app'),
                content: document.getElementById('content-area'),
                progressBar: document.getElementById('progress-bar'),
                progressContainer: document.getElementById('progress-container'),
                nextBtn: document.getElementById('next-btn'),
                backBtn: document.getElementById('back-btn'),
                calcBtn: document.getElementById('calculate-btn'),
                footer: document.getElementById('nav-footer'),
                loading: document.getElementById('initial-loading'),
                msgBox: document.getElementById('message-box'),
                welcome: document.getElementById('welcome-screen'),
                progressText: document.getElementById('progress-text'),
                settingsBtn: document.getElementById('settings-btn'),
                settingsModal: document.getElementById('settings-modal'),
                hfInput: document.getElementById('hf-token-input'),
                saveSettings: document.getElementById('save-settings'),
                closeSettings: document.getElementById('close-settings')
            };

            this.els.welcome.classList.remove('hidden');
            document.getElementById('start-btn').addEventListener('click', () => {
                this.els.welcome.classList.add('hidden');
                this.els.app.classList.remove('hidden');
                setTimeout(() => this.els.app.classList.remove('opacity-0'), 50);
                this.gotoStep(0);
            });
            this.els.nextBtn.addEventListener('click', () => this.nextStep());
            this.els.backBtn.addEventListener('click', () => this.prevStep());
            this.els.calcBtn.addEventListener('click', () => this.showResults());
            
            // Settings
            this.els.settingsBtn.addEventListener('click', () => {
                this.els.settingsModal.classList.remove('hidden');
                this.els.hfInput.value = AIModule.token;
            });
            this.els.closeSettings.addEventListener('click', () => this.els.settingsModal.classList.add('hidden'));
            this.els.saveSettings.addEventListener('click', () => {
                AIModule.saveToken(this.els.hfInput.value);
                this.els.settingsModal.classList.add('hidden');
                this.toast("AI TOKEN SAVED");
            });

            setTimeout(() => {
                this.els.loading.classList.add('hidden');
                this.els.content.classList.remove('hidden');
                this.els.footer.classList.remove('hidden');
                document.getElementById('progress-container').classList.remove('hidden');
            }, 800);
        },

        toast(msg, isError = false) {
            if (!this.els || !this.els.msgBox) {
                const box = document.getElementById('message-box');
                if (!box) return; 
                box.textContent = > ${msg};
                box.className = mt-4 p-3 text-xs font-mono text-center transition-all fade-in border ${isError ? 'bg-red-900/20 text-red-400 border-red-900' : 'bg-zinc-900 text-zinc-300 border-zinc-700'};
                box.classList.remove('hidden');
                setTimeout(() => box.classList.add('hidden'), 3000);
                return;
            }
            this.els.msgBox.textContent = > ${msg};
            this.els.msgBox.className = mt-4 p-3 text-xs font-mono text-center transition-all fade-in border ${isError ? 'bg-red-900/20 text-red-400 border-red-900' : 'bg-zinc-900 text-zinc-300 border-zinc-700'};
            this.els.msgBox.classList.remove('hidden');
            setTimeout(() => this.els.msgBox.classList.add('hidden'), 3000);
        },

        updateProgress(stepIdx) {
            const pct = Math.round(((stepIdx + 1) / this.steps.length) * 100);
            this.els.progressBar.style.width = ${pct}%;
            this.els.progressText.textContent = ${pct.toString().padStart(2, '0')}%;
        },

        gotoStep(idx) {
            AppData.state.step = idx;
            const stepConfig = this.steps[idx] || this.steps[this.steps.length-1];
            if (idx === 3 && AppData.state.activeQuestions.length === 0) AppData.generateQuiz();
            this.els.content.innerHTML = '';
            this.els.content.classList.remove('fade-in');
            void this.els.content.offsetWidth; 
            this.els.content.classList.add('fade-in');
            this[stepConfig.render]();
            this.updateProgress(idx);
            this.updateNavState();
        },

        nextStep() { if (this[this.steps[AppData.state.step].validate]()) this.gotoStep(AppData.state.step + 1); },
        prevStep() { if (AppData.state.step > 0) this.gotoStep(AppData.state.step - 1); },
        
        async showResults() {
            const needsRefinement = AppData.checkAmbiguity();
            if (needsRefinement && !AppData.state.isRefining) {
                this.renderRefinement();
                return;
            }
            AppData.calculateResults();
            if (AIModule.token) {
                this.els.loading.classList.remove('hidden');
                this.els.content.classList.add('hidden');
                AppData.state.aiResponse = await AIModule.generateInsight(AppData.state);
                this.els.loading.classList.add('hidden');
                this.els.content.classList.remove('hidden');
            }
            FirebaseModule.save();
            this.gotoStep(4);
        },

        updateNavState() {
            const s = AppData.state.step;
            this.els.backBtn.disabled = s === 0;
            if (s === 3 || s === 4) {
                this.els.footer.classList.add('hidden');
            } else {
                this.els.footer.classList.remove('hidden');
            }
            if (s < 3) {
                this.els.nextBtn.classList.remove('hidden');
                this.els.calcBtn.classList.add('hidden');
                this.els.nextBtn.disabled = !this[this.steps[s].validate](true);
            }
        },

        renderIdentity() {
            this.els.content.innerHTML = `
                <h2 class="text-2xl font-bold text-white mb-2">IDENTITY</h2>
                <p class="text-zinc-500 text-sm mb-8 font-mono">WHO ARE YOU?</p>
                <div class="space-y-6">
                    <div>
                        <label class="block text-[10px] font-bold text-zinc-400 uppercase tracking-widest mb-2">Full Name</label>
                        <input id="in-name" type="text" value="${AppData.state.user.name}" class="w-full p-4 input-mono text-sm" placeholder="ENTER NAME">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-zinc-400 uppercase tracking-widest mb-2">Current Grade Level</label>
                        <div class="flex gap-4">
                            <button class="grade-btn flex-1 p-4 input-mono text-center text-sm uppercase font-bold transition-colors ${AppData.state.user.grade === '10' ? 'bg-white text-black' : 'text-zinc-500'}" data-val="10">Class 10</button>
                            <button class="grade-btn flex-1 p-4 input-mono text-center text-sm uppercase font-bold transition-colors ${AppData.state.user.grade === '12' ? 'bg-white text-black' : 'text-zinc-500'}" data-val="12">Class 12 / Above</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('in-name').addEventListener('input', (e) => {
                AppData.state.user.name = e.target.value;
                this.els.nextBtn.disabled = !this.validateIdentity(true);
            });
            this.els.content.querySelectorAll('.grade-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    AppData.state.user.grade = btn.dataset.val;
                    this.renderIdentity();
                });
            });
        },

        renderBackground() {
            const is10th = AppData.state.user.grade === '10';
            let innerHTML = '';
            if (is10th) {
                innerHTML = `
                    <h2 class="text-2xl font-bold text-white mb-2">ACADEMIC PROFILE (10th)</h2>
                    <p class="text-zinc-500 text-sm mb-6 font-mono">YOUR STRONG POINTS</p>
                    <div class="mb-6">
                        <label class="block text-[10px] font-bold text-zinc-400 uppercase tracking-widest mb-2">Strongest Subject</label>
                        <div class="grid grid-cols-2 gap-2">
                            ${AppData.subjects.map(s => <button class="subj-opt selection-card p-3 text-left text-xs ${AppData.state.user.subject === s.id ? 'active' : ''}" data-id="${s.id}">${s.label}</button>).join('')}
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-zinc-400 uppercase tracking-widest mb-2">10th Grade Marks (Predicted %)</label>
                        <input id="in-marks" type="number" value="${AppData.state.user.marks}" class="w-full p-4 input-mono text-sm" placeholder="0-100">
                    </div>
                `;
            } else {
                innerHTML = `
                    <h2 class="text-2xl font-bold text-white mb-2">ACADEMIC STREAM (12th)</h2>
                    <p class="text-zinc-500 text-sm mb-6 font-mono">WHAT DID YOU STUDY?</p>
                    <div class="grid grid-cols-1 gap-3 mb-6">
                        ${AppData.streams.map(s => <button class="stream-opt selection-card p-4 text-left ${AppData.state.user.stream === s.id ? 'active' : ''}" data-id="${s.id}"><span class="text-sm font-mono uppercase tracking-wider pointer-events-none">${s.label}</span></button>).join('')}
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-zinc-400 uppercase tracking-widest mb-2">12th Grade %</label>
                        <input id="in-marks" type="number" value="${AppData.state.user.marks}" class="w-full p-4 input-mono text-sm" placeholder="0-100">
                    </div>
                `;
            }
            this.els.content.innerHTML = innerHTML;
            if(is10th) {
                this.els.content.querySelectorAll('.subj-opt').forEach(btn => {
                    btn.addEventListener('click', () => { AppData.state.user.subject = btn.dataset.id; this.renderBackground(); this.els.nextBtn.disabled = !this.validateBackground(true); });
                });
            } else {
                this.els.content.querySelectorAll('.stream-opt').forEach(btn => {
                    btn.addEventListener('click', () => { AppData.state.user.stream = btn.dataset.id; this.renderBackground(); this.els.nextBtn.disabled = !this.validateBackground(true); });
                });
            }
            document.getElementById('in-marks').addEventListener('input', (e) => { AppData.state.user.marks = e.target.value; this.els.nextBtn.disabled = !this.validateBackground(true); });
        },

        renderInterests() {
            const currentStream = AppData.state.user.stream;
            const is10th = AppData.state.user.grade === '10';
            const filteredInterests = AppData.interestsList.filter(i => is10th || i.streams.includes('All') || i.streams.includes(currentStream));
            const html = filteredInterests.map(opt => {
                const active = AppData.state.user.interests.includes(opt.id);
                return <button class="selection-card p-4 text-left h-full flex flex-col justify-center ${active ? 'active' : ''}" data-id="${opt.id}"><span class="text-xs md:text-sm font-mono uppercase tracking-wider block pointer-events-none">${opt.label}</span></button>;
            }).join('');
            this.els.content.innerHTML = <h2 class="text-2xl font-bold text-white mb-2">INTERESTS</h2><p class="text-zinc-500 text-sm mb-8 font-mono">WHAT DO YOU LOVE?</p><div class="grid grid-cols-2 gap-4 max-h-[300px] overflow-y-auto pr-2">${html}</div>;
            this.els.content.querySelectorAll('.selection-card').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    if (AppData.state.user.interests.includes(id)) AppData.state.user.interests = AppData.state.user.interests.filter(t => t !== id);
                    else AppData.state.user.interests.push(id);
                    this.renderInterests();
                    this.els.nextBtn.disabled = !this.validateInterests(true);
                });
            });
        },

        renderQuiz() {
            const totalQ = AppData.state.activeQuestions.length;
            const idx = AppData.state.quizIndex;
            
            if (idx >= totalQ) {
                this.showResults();
                return;
            }

            const q = AppData.state.activeQuestions[idx];
            const html = `
                <div class="flex-grow flex flex-col justify-center h-full slide-in-right">
                    <div class="mb-8">
                        <p class="text-xs font-mono text-zinc-500 mb-2 uppercase tracking-widest">Question ${idx + 1} / ${totalQ}</p>
                        <h3 class="text-xl md:text-2xl font-bold text-white leading-snug">"${q.text}"</h3>
                    </div>
                    <div class="space-y-3">
                        ${[1,2,3,4,5].map(opt => {
                            const labels = ['Strongly Disagree', 'Disagree', 'Neutral', 'Agree', 'Strongly Agree'];
                            return `
                            <button class="quiz-opt w-full p-4 border border-zinc-800 text-left transition-all hover:bg-white hover:text-black hover:border-white hover:shadow-[0_0_20px_rgba(255,255,255,0.2)] flex justify-between items-center group"
                                data-val="${opt}">
                                <span class="text-sm font-mono uppercase tracking-wide">${labels[opt-1]}</span>
                                <span class="text-xs text-zinc-600 group-hover:text-black opacity-0 group-hover:opacity-100 transition-opacity">SELECT â†’</span>
                            </button>
                            `;
                        }).join('')}
                    </div>
                    <div class="mt-8 flex justify-between items-center">
                        <button id="quiz-back" class="text-xs text-zinc-500 hover:text-white uppercase tracking-widest disabled:opacity-30" ${idx===0?'disabled':''}>â† Previous</button>
                    </div>
                </div>
            `;
            
            this.els.content.innerHTML = html;

            // Auto-advance logic
            this.els.content.querySelectorAll('.quiz-opt').forEach(btn => {
                btn.addEventListener('click', () => {
                    const val = parseInt(btn.dataset.val);
                    AppData.state.answers[q.id] = val;
                    
                    // Visual feedback
                    btn.classList.add('bg-white', 'text-black');
                    
                    setTimeout(() => {
                        AppData.state.quizIndex++;
                        this.els.content.firstElementChild.classList.add('slide-out-left'); // Animate out
                        setTimeout(() => this.renderQuiz(), 200); // Wait for anim then render next
                    }, 250);
                });
            });

            document.getElementById('quiz-back').addEventListener('click', () => {
                if(AppData.state.quizIndex > 0) {
                    AppData.state.quizIndex--;
                    this.renderQuiz();
                } else {
                    // Go back to interests
                    this.gotoStep(2);
                }
            });
        },

        renderRefinement() {
            const selectedIds = AppData.state.user.interests;
            const options = AppData.interestsList.filter(i => selectedIds.includes(i.id));
            const html = options.map(opt => {
                const isSelected = AppData.state.refinedInterests.includes(opt.id);
                return <button class="selection-card p-4 text-left h-full flex flex-col justify-center ${isSelected ? 'active' : ''}" data-id="${opt.id}"><span class="text-xs md:text-sm font-mono uppercase tracking-wider block pointer-events-none">${opt.label}</span></button>;
            }).join('');

            this.els.content.innerHTML = `
                <div class="border border-red-500/50 bg-red-500/10 p-4 mb-6">
                    <h2 class="text-xl font-bold text-white mb-1">CLARIFICATION REQUIRED</h2>
                    <p class="text-red-200 text-xs font-mono">AMBIGUOUS PROFILE DETECTED. WE NEED MORE PRECISION.</p>
                </div>
                <p class="text-zinc-400 text-sm mb-6">Select exactly <strong>TWO</strong> favorites from below:</p>
                <div class="grid grid-cols-1 gap-3">${html}</div>
                <div class="mt-8 text-right">
                    <button id="submit-refinement" class="btn-mono btn-mono-primary px-8 py-3 rounded-none text-xs font-bold uppercase tracking-widest" disabled>Analyze Final Path</button>
                </div>
            `;
            const submitBtn = document.getElementById('submit-refinement');
            this.els.content.querySelectorAll('.selection-card').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.dataset.id;
                    if (AppData.state.refinedInterests.includes(id)) {
                        AppData.state.refinedInterests = AppData.state.refinedInterests.filter(t => t !== id);
                    } else {
                        if(AppData.state.refinedInterests.length < 2) AppData.state.refinedInterests.push(id);
                    }
                    btn.classList.toggle('active', AppData.state.refinedInterests.includes(id));
                    submitBtn.disabled = AppData.state.refinedInterests.length !== 2;
                });
            });
            submitBtn.addEventListener('click', () => {
                AppData.state.isRefining = true;
                this.showResults();
            });
            this.els.footer.classList.add('hidden');
        },

        renderResults() {
            const recs = AppData.state.recommendations;
            const is10th = AppData.state.user.grade === '10';
            const subHeader = is10th ? "RECOMMENDED STREAMS (CLASS 11)" : "CAREER RECOMMENDATIONS";

            const cardsHtml = recs.map((rec, i) => `
                <div class="p-6 border border-zinc-800 bg-zinc-900/30 mb-4 hover:bg-zinc-900 transition-colors group">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-bold text-white group-hover:underline decoration-1 underline-offset-4">#${i+1} ${rec.name}</h3>
                        <span class="px-2 py-1 bg-white text-black text-[10px] font-bold font-mono">${rec.finalScore}% MATCH</span>
                    </div>
                    <p class="text-xs text-zinc-400 mb-4 leading-relaxed font-light">${rec.desc}</p>
                    <div class="text-[10px] text-zinc-500 border-t border-zinc-800 pt-3 font-mono uppercase"><strong class="text-zinc-300">PATH ></strong> ${rec.path}</div>
                </div>
            `).join('');

            let aiHtml = '';
            if (AppData.state.aiResponse) {
                aiHtml = <div class="md:col-span-3 p-6 border border-white bg-white/10 relative overflow-hidden mb-4"><div class="absolute top-0 right-0 p-2 text-[10px] bg-white text-black font-bold font-mono">AI GENERATED INSIGHT</div><div class="ai-response text-sm text-zinc-200 leading-relaxed font-light">${Utils.sanitize(AppData.state.aiResponse).replace(/\n/g, '<br>')}</div></div>;
            } else if (!AIModule.token) {
                aiHtml = <div class="md:col-span-3 p-4 border border-zinc-800 border-dashed text-center mb-4"><p class="text-zinc-500 text-xs font-mono">SMART AI DISABLED. CONFIGURE TOKEN IN SETTINGS.</p></div>;
            }

            // Add Roadmap Button
            const roadmapBtnHtml = AIModule.token ? `
                <div class="mt-8 text-center space-x-4">
                    <button id="generate-roadmap-btn" class="btn-mono btn-mono-primary px-6 py-3 rounded-none text-xs font-bold uppercase tracking-widest">âœ¨ Generate Roadmap</button>
                    <button id="restart-btn" class="text-xs text-zinc-500 hover:text-white hover:underline transition-colors font-mono uppercase tracking-widest">Reset System</button>
                </div>
            ` : `
                <div class="mt-8 text-center">
                    <button id="restart-btn" class="text-xs text-zinc-500 hover:text-white hover:underline transition-colors font-mono uppercase tracking-widest">Reset System</button>
                </div>
            `;

            this.els.content.innerHTML = `
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-white mb-1">ANALYSIS COMPLETE</h2>
                    <p class="text-zinc-500 text-xs font-mono uppercase">Blueprint for ${AppData.state.user.name}</p>
                </div>
                <div class="grid md:grid-cols-3 gap-8 h-full">
                    ${aiHtml}
                    <div class="md:col-span-1 p-6 border border-zinc-800 bg-black/20">
                        <h3 class="text-xs font-bold text-white uppercase tracking-widest mb-6 pb-2 border-b border-zinc-800">ACADEMIC DATA</h3>
                        <p class="text-sm text-zinc-300 font-mono mb-2">GRADE: ${is10th ? '10th' : '12th/College'}</p>
                        <p class="text-sm text-zinc-300 font-mono mb-2">MARKS: ${AppData.state.user.marks}%</p>
                        <p class="text-sm text-zinc-300 font-mono">INTERESTS: ${AppData.state.user.interests.length}</p>
                    </div>
                    <div class="md:col-span-2">
                        <h3 class="text-xs font-bold text-white uppercase tracking-widest mb-4 pb-2 border-b border-zinc-800">${subHeader}</h3>
                        <div class="overflow-y-auto max-h-[450px] pr-1">${cardsHtml}</div>
                    </div>
                </div>
                
                <div id="roadmap-container" class="hidden mt-8 p-6 border border-zinc-700 bg-zinc-900/50">
                    <h3 class="text-lg font-bold text-white mb-4">LEARNING ROADMAP</h3>
                    <div id="roadmap-content" class="text-sm text-zinc-300 font-mono leading-relaxed whitespace-pre-line"></div>
                </div>

                ${roadmapBtnHtml}
            `;
            
            document.getElementById('restart-btn').addEventListener('click', () => location.reload());
            
            if (AIModule.token) {
                document.getElementById('generate-roadmap-btn').addEventListener('click', async (e) => {
                    const btn = e.target;
                    btn.disabled = true;
                    btn.textContent = "Generating...";
                    
                    const roadmap = await AIModule.generateRoadmap(AppData.state);
                    
                    document.getElementById('roadmap-container').classList.remove('hidden');
                    document.getElementById('roadmap-content').textContent = roadmap;
                    btn.textContent = "Roadmap Generated";
                });
            }
        },

        validateIdentity() { return AppData.state.user.name.length > 2; },
        validateBackground() {
            const is10th = AppData.state.user.grade === '10';
            const hasMarks = AppData.state.user.marks !== '' && !isNaN(AppData.state.user.marks);
            if (is10th) return hasMarks && AppData.state.user.subject !== '';
            else return hasMarks && AppData.state.user.stream !== '';
        },
        validateInterests() { return AppData.state.user.interests.length > 0; },
        // Quiz validation is handled internally by the flow now
        validateQuiz() { return true; } 
    };

    ThreeBG.init();
    UI.init();
    FirebaseModule.init();
</script>
</body>
</html>
  // Prepare dynamic quiz order based on subject hints (simple
